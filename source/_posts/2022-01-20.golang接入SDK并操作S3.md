---
author: 小莫 
date: 2022-01-20 
title: golang接入SDK并操作S3 
tags:
- react 
category: aws 
permalink: golangAwsS3

---
从java转到golang之后很多之前熟悉的SDK接入方式都得再从头看一遍接入文档，不过即便编程语言不同使用起来也只是语法上的区别，了解了思想都不是问题。最近开始使用golang开发应用程序，然后需要接入AWS SDK。

<!-- more -->

## 准备工作

- golang项目
- AWS CLI
- AWS 账号授权

## 在项目中安装依赖

```gotemplate
go get github.com/aws/aws-sdk-go-v2
go get github.com/aws/aws-sdk-go-v2/config
go get github.com/aws/aws-sdk-go-v2/service/s3
```

## 示例

```goregexp
package awscli

import (
	"context"
	"fmt"
	"g123-i18n/config"
	"github.com/aws/aws-sdk-go-v2/aws"
	v4 "github.com/aws/aws-sdk-go-v2/aws/signer/v4"
	awsConfig "github.com/aws/aws-sdk-go-v2/config"
	"github.com/aws/aws-sdk-go-v2/service/s3"
	"github.com/aws/aws-sdk-go-v2/service/s3/types"
	"os"
	"time"
)

var (
	s3Client   *s3.Client
	s3PsClient *s3.PresignClient
)

func InitAwsSdk() error {
	var (
		cfg aws.Config
		err error
	)
	appConfig := config.GetConfig().App
	profile, region := appConfig.AwsProfile, "ap-northeast-1"

	if appConfig.Env == config.Local {
		cfg, err = awsConfig.LoadDefaultConfig(context.TODO(), awsConfig.WithSharedConfigProfile(profile))
	} else {
		cfg, err = awsConfig.LoadDefaultConfig(context.TODO(), awsConfig.WithRegion(region))
	}
	if err != nil {
		return err
	}

	s3Client = s3.NewFromConfig(cfg)
	s3PsClient = s3.NewPresignClient(s3Client)
	if s3Client == nil || s3PsClient == nil {
		return fmt.Errorf("init s3 client fail")
	}
	return nil
}

// UploadToS3FromPath
// filePath 本地的文件地址+文件名 ./jsonFile/zip/xxx.zip
// destPath s3桶内部的地址不带s3://, 例: seirei/ob5.0/ja-JP
// acl ObjectCannedACL,设置读取权限,默认private
func UploadToS3FromPath(filePath string, destPath string, acl ...types.ObjectCannedACL) (*s3.PutObjectOutput, error) {
	file, err := os.OpenFile(filePath, os.O_RDWR|os.O_CREATE, 0755)
	if err != nil {
		return nil, err
	}
	return UploadToS3FromFile(file, destPath, acl...)

}

// UploadToS3FromPath
// file 要上传的文件
// destPath s3桶内部的地址不带s3://, 例: seirei/ob5.0/ja-JP
// acl ObjectCannedACL,设置读取权限,默认private
func UploadToS3FromFile(file *os.File, destPath string, acl ...types.ObjectCannedACL) (*s3.PutObjectOutput, error) {
	if len(acl) > 1 {
		panic("too many acl arguments")
	}
	objectAcl := types.ObjectCannedACLPrivate
	if len(acl) == 1 {
		objectAcl = acl[0]
	}

	bucket := aws.String(config.GetConfig().App.S3Bucket)
	putObjectInput := &s3.PutObjectInput{
		Bucket: bucket,
		Key:    aws.String(destPath),
		Body:   file,
		ACL:    objectAcl,
	}
	object, err := s3Client.PutObject(context.TODO(), putObjectInput)
	return object, err
}

// GetObjectTempUrl
// 默认1小时
func GetObjectTempUrl(filePath string) (*string, error) {
	bucket := aws.String(config.GetConfig().App.S3Bucket)
	getObjectInput := &s3.GetObjectInput{
		Bucket: bucket,
		Key:    aws.String(filePath),
	}
	resp, err := getPresignURL(context.TODO(), s3PsClient, getObjectInput)
	if err != nil {
		return nil, err
	}
	return &resp.URL, nil
}

type s3PresignGetObjectAPI interface {
	PresignGetObject(
		ctx context.Context,
		params *s3.GetObjectInput,
		optFns ...func(*s3.PresignOptions)) (*v4.PresignedHTTPRequest, error)
}

func getPresignURL(c context.Context, api s3PresignGetObjectAPI, input *s3.GetObjectInput) (*v4.PresignedHTTPRequest, error) {
	return api.PresignGetObject(c, input, func(presignOptions *s3.PresignOptions) {
		presignOptions.Expires = time.Hour
	})
}

```


## 使用方式
在项目启动时调用 `awscli.InitAwsSdk()`来初始化s3的客户端，然后在使用的地方调用

```goregexp
        // 具体使用方法
		output, err := awscli.UploadToS3FromPath(tempPath, s3ZipPath, types.ObjectCannedACLPublicRead)

```


## 授权方式

1. credential方式：会自动读取本地的`~/.aws/config`目录中的配置信息   
   `cfg, err := config.LoadDefaultConfig(context.TODO())`

2. Role： 无需在程序中配置    
在k8s中给pod添加s3的role

- 创建一个s3存储桶，并授予读写权限
- 创建一个k8s的iam角色，和k8s的cluster绑定并给k8s对s3的读写权限

```terraform
// s3
resource "aws_s3_bucket" "this" {
   bucket = "${local.environment}-${local.service}"
   acl    = "private"

   versioning {
      enabled = true
   }

   force_destroy = false
}


resource "aws_s3_bucket_policy" "this" {
   bucket = aws_s3_bucket.this.id

   policy = jsonencode({
      "Version" : "2012-10-17"
      "Statement" : [
         {
            "Sid" : "allow-roles",
            "Effect" : "Allow",
            "Principal" : "*",
            "Action" : "s3:*",
            "Resource" : "arn:aws:s3:::${aws_s3_bucket.this.id}/*"
            "Condition" : {
               "ArnLike" : {
                  "aws:SourceArn" : [
                     "arn:aws:iam::${data.aws_caller_identity.self.account_id}:user/*",
                     "arn:aws:iam::${data.aws_caller_identity.self.account_id}:role/${local.environment}-${local.service}*",
                  ]
               }
            }
         },
      ]
   })
}



// k8s_iam_role
resource "aws_iam_role" "s3" {
  name                  = "${local.environment}-${local.service}-role"
  force_detach_policies = false
  max_session_duration  = 3600
  path                  = "/"
  tags                  = {}
  assume_role_policy    = data.aws_iam_policy_document.assume_g123_i18n_role_policy.json

  inline_policy {
    name = "policy-s3"
    policy = jsonencode({
      "Version" : "2012-10-17"
      Statement = [
        {
          Action = [
            "s3:Get*",
            "s3:List*",
            "s3:PutObject",
            "s3:PutObjectAcl",
            "s3:DeleteObject",
            "s3:AbortMultipartUpload",
          ]
          Effect = "Allow"
          Resource = [
            "arn:aws:s3:::${local.environment}-g123-i18n",
            "arn:aws:s3:::${local.environment}-g123-i18n/*",
          ]
        },
      ]
      }
    )
  }
}

data "aws_iam_policy_document" "assume_g123_i18n_role_policy" {
  statement {
    actions = ["sts:AssumeRoleWithWebIdentity"]
    effect  = "Allow"

    condition {
      test     = "StringEquals"
      variable = "oidc.eks.${local.region}.amazonaws.com/id/8C6E2E386D4F9E20A0A25069B6CFC1FF:sub"
      values   = ["system:serviceaccount:${local.k8s_namespace}:${local.service}-api-sa"]
    }

    principals {
      identifiers = [
        "arn:aws:iam::${data.aws_caller_identity.self.account_id}:oidc-provider/oidc.eks.${local.region}.amazonaws.com/id/8C6E2E386D4F9E20A0A25069B6CFC1FF"
      ]
      type = "Federated"
    }
  }
}


// local.tf
locals {
   profile = "g123-stg"       #Profile for DEFAULT region, the same as AWS account ALIAS
   region  = "ap-northeast-1" #DEFAULT region
   env     = "staging"

   redis = {
      engine                   = "redis"
      engine_version           = "6.x"
      node_type                = "cache.t2.small"
      number_cache_clusters    = 2
      snapshot_retention_limit = 7
      replication_group_id     = "redis"
      name                     = "${local.profile}-redis"
      subnet_name              = "${local.profile}-redis-subnet"
      sg_name                  = "${local.profile}-redis-sg"
      port                     = 6379
      vpc_cidr                 = local.vpc.cidr.primary
      ingress_cidr             = data.external.vpc_g123_stg_k8s.result.cidr
      egress_cidr              = "127.0.0.1/32"
      backup_bucket            = "${local.env}-g123-redis-backup"
   }
}



```






